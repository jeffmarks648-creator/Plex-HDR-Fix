# This is a sample mpv.conf file. You may edit this file as you desire to change MPV's behavior. See the mpv.conf.md file for more info

vo=gpu-next

# --- GPU Setting ---
gpu-context=d3d11
gpu-api=d3d11
# For Mac:
# gpu-context=cocoa
# gpu-api=opengl

profile=high-quality
osd-font-size=20

# Reset scale for new play if changed
hwdec=auto-copy
video-unscaled=no
video-zoom = 0
panscan = 0
vf="pad=ceil(iw/4)*4:ceil(ih/2)*2"

# Use osd-msg1 to switch between MPV defaults and custom profiles
# "auto": MPV Default behavior
# "custom": Custom tone mapping profiles below
osd-msg1="custom"

# Setup the default output of MPV
# yes: default output as HDR
# no: default output as SDR
target-colorspace-hint=no

# --- Global Profiles ---
# Plex config are for vo=gpu, this config is for vo=gpu-next to remove the blur (esp 1080p)
scale=ewa_lanczossharp   
scale-antiring=0         
dscale=mitchell
dscale-antiring=0        
cscale=spline36          
cscale-antiring=0
deband=yes
deband-iterations=2
deband-threshold=28
deband-range=12
deband-grain=5
correct-downscaling=yes
linear-downscaling=no
sigmoid-upscaling=yes

# --- Shader ---
glsl-shaders-clr
glsl-shaders-append="~~/shaders/KrigBilateral.glsl"
glsl-shaders-append="~~/shaders/SSimSuperRes-mitchell.glsl"
glsl-shaders-append="~~/shaders/SSimDownscaler.glsl"

# --- Tone Mapping Setting ---
hdr-peak-percentile=99.9
hdr-contrast-recovery=0.3

# --- Video Profiles ---
video-sync=display-resample
interpolation=no
tscale=oversample

# --- Dot-To-Dot Profiles ---
# This to disable upscale if the width difference < 10 pixel. e.g. 1918 or 3836 width
# Mainly prevent blur due to just upsacling for several pixels.
[dot-to-dot-fix]
profile-restore=copy
profile-cond=p["dwidth"] >= (p["osd-width"] - 10) and p["dwidth"] < p["osd-width"] and p["panscan"] == 0
video-unscaled=downscale-big

# --- Filter Profiles ---
# Change hwdec to auto in case no need to pack black bar for 4-pixel aligment
[hwdec-auto-fix]
profile-restore=copy
profile-cond=p["height"] ~= nil and p["width"] ~= nil and p["height"] % 2 == 0 and p["width"] % 4 == 0
hwdec=auto

# This is to detect any change in width cropped by filter and use hwdec=auto-copy for processing.
# Expect tone mapping only work on cropped area instead of full screen.
[vf-hwdec-fix]
profile-restore=copy
profile-cond=p["dwidth"] ~= nil and p["width"] ~= nil and p["dwidth"] < p["width"]
hwdec=auto-copy

# This scale down the ass/ssa subtitle as it is enlarged with cropped screen and zoom
[scale-sub-ass-fix]
profile-restore=copy
profile-cond=((p["dwidth"] ~= nil and p["width"] ~= nil and p["dwidth"] < p["width"]) or p["video-zoom"] ~= 0 or p["panscan"] ~= 0) and (p["current-tracks/sub/codec"] == "ass" or p["current-tracks/sub/codec"] == "ssa")
sub-scale=0.8

# This force the subtitle on windows in case zooming a 16:9 screen
[zoom-sub-ass-fix]
profile-restore=copy
profile-cond=p["video-params/aspect"] ~= nil and p["video-params/aspect"] < 1.8 and p["video-zoom"] > 0 and (p["current-tracks/sub/codec"] == "ass" or p["current-tracks/sub/codec"] == "ssa")
sub-ass-scale-with-window=no
sub-use-margins=yes
sub-ass-force-margins=yes

# --- Output Default Profiles ---
[SDR-Output]
profile-cond=p["target-colorspace-hint"] == false
# For 8-bit SDR Monitor as MPV somehow wrongly determine 10-bit output
d3d11-output-format=rgba8
dither-depth=8
dither=fruit

[HDR-Output]
profile-cond=p["target-colorspace-hint"] == true
d3d11-output-format=auto
dither-depth=auto
dither=error-diffusion

# --- MPV Default Profiles ---
[MPV-Default]
profile-cond=p["options/osd-msg1"] == "auto"
target-peak=auto
hdr-compute-peak=no
inverse-tone-mapping=yes
tone-mapping=auto
tone-mapping-param=0.3 # assume spline
saturation=0

# --- SDR Monitor Profiles ---
[SDR-SDR-Default]
profile-cond=p["video-params/sig-peak"] <= 1 and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
target-peak=auto
hdr-compute-peak=no
inverse-tone-mapping=no
tone-mapping=auto

[HDR-SDR-Default]
profile-cond=p["video-params/sig-peak"] > 1 and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
# Set your target peak for SDR monitor, default is 203 which is too high and dull, 170 for better contrast
target-peak=170
hdr-compute-peak=yes
inverse-tone-mapping=no
tone-mapping=spline

# --- HDR Monitor Profiles ---
[HDR-HDR-Default]
profile-cond=p["video-params/sig-peak"] > 1 and p["target-colorspace-hint"] == true and p["options/osd-msg1"] == "custom"
# Set your target peak for HDR monitor, this should exectly match your win profile to prevent additional conversion.
# DONT set to auto as MPV will skip the tone mapping and just pass-through.
target-peak=400
hdr-compute-peak=yes
inverse-tone-mapping=no
tone-mapping=auto
tone-mapping-param=0.3 # assume spline
saturation=0

[SDR-HDR-Default]
profile-cond=p["video-params/sig-peak"] <= 1 and p["target-colorspace-hint"] == true and p["options/osd-msg1"] == "custom"
# Set your target peak for HDR monitor, this should exectly match your win profile to prevent additional conversion.
# DONT set to auto as MPV will skip the tone mapping and just pass-through.
target-peak=400
hdr-compute-peak=no
inverse-tone-mapping=yes
tone-mapping=auto
tone-mapping-param=0.30
saturation=1.2

# --- HDR-SDR Tone Mapping Profile ---
# Below profiles only take effect for HDR to SDR output.

[TM-User-Auto]
profile-cond=p["tone-mapping"] == 'auto' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=0.3 # assume spline
saturation=0

[TM-User-BT2446a]
profile-cond=p["tone-mapping"] == 'bt.2446a' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=0.38
saturation=2

[TM-User-BT2390]
profile-cond=p["tone-mapping"] == 'bt.2390' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=1.2
saturation=1

[TM-User-ST2094-40]
profile-cond=p["tone-mapping"] == 'st2094-40' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=1.0
saturation=2

[TM-User-ST2094-10]
profile-cond=p["tone-mapping"] == 'st2094-10' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=1.0
saturation=2

[TM-User-Mobius]
profile-cond=p["tone-mapping"] == 'mobius' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=0.50
saturation=2

[TM-User-Spline]
profile-cond=p["tone-mapping"] == 'spline' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=0.32
saturation=3

[TM-User-Reinhard]
profile-cond=p["tone-mapping"] == 'reinhard' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=0.50
saturation=4

[TM-User-Hable]
profile-cond=p["tone-mapping"] == 'hable' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=1.0
saturation=2

[TM-User-Gamma]
profile-cond=p["tone-mapping"] == 'gamma' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=2.2
saturation=0

[TM-User-Linear]
profile-cond=p["tone-mapping"] == 'linear' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=1.0
saturation=0

[TM-User-Clip]
profile-cond=p["tone-mapping"] == 'clip' and p["target-colorspace-hint"] == false and p["options/osd-msg1"] == "custom"
tone-mapping-param=1.0
saturation=0
